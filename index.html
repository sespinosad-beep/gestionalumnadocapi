<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Alumnado - Centro AcadÃ©mico Privado de InglÃ©s Sevilla, 56 BailÃ©n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        :root{--primary:#1e3a5f;--primary-light:#2c5282;--primary-soft:#e8f0fe;--accent:#3b82f6;--accent-light:#93c5fd;--accent-soft:#dbeafe;--red:#dc2626;--red-light:#fca5a5;--red-pastel:#ffe4e6;--red-dark:#991b1b;--orange:#f59e0b;--orange-soft:#fef3c7;--purple:#7c3aed;--purple-soft:#ede9fe;--bg:#f1f5f9;--bg-warm:#f8fafc;--card:#fff;--text:#1e293b;--text-sec:#64748b;--text-muted:#94a3b8;--border:#e2e8f0;--border-light:#f1f5f9;--shadow:0 4px 6px -1px rgba(0,0,0,0.07);--shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1);--radius:16px;--radius-md:12px;--radius-sm:8px;--radius-xs:6px;}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
        .header{background:linear-gradient(135deg,var(--primary),var(--primary-light),var(--accent));color:#fff;box-shadow:var(--shadow-lg);position:sticky;top:0;z-index:100;}
        .header-top{display:flex;justify-content:space-between;align-items:center;padding:18px 30px;flex-wrap:wrap;gap:12px;}
        .header-brand{display:flex;align-items:center;gap:15px;}
        .header-logo{width:50px;height:50px;background:rgba(255,255,255,.2);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;}
        .header-info h1{font-size:1.15rem;font-weight:700;}
        .header-info p{font-size:.78rem;opacity:.85;}
        .header-actions{display:flex;gap:8px;flex-wrap:wrap;}
        .btn{padding:9px 18px;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:.82rem;font-weight:600;display:inline-flex;align-items:center;gap:6px;transition:all .2s;font-family:inherit;}
        .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow);}
        .btn-primary{background:var(--accent);color:#fff;}
        .btn-success{background:#10b981;color:#fff;}
        .btn-danger{background:var(--red);color:#fff;}
        .btn-warning{background:var(--orange);color:#fff;}
        .btn-purple{background:var(--purple);color:#fff;}
        .btn-outline-white{background:rgba(255,255,255,.12);border:1.5px solid rgba(255,255,255,.35);color:#fff;}
        .btn-ghost{background:transparent;color:var(--text-sec);border:1.5px solid var(--border);}
        .btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
        .btn-sm{padding:6px 14px;font-size:.78rem;}
        .container{max-width:1440px;margin:0 auto;padding:24px;}
        .tabs{display:flex;gap:4px;margin-bottom:24px;background:var(--card);padding:6px;border-radius:var(--radius);box-shadow:var(--shadow);flex-wrap:wrap;border:1px solid var(--border-light);}
        .tab{padding:11px 20px;border:none;background:transparent;border-radius:var(--radius-md);cursor:pointer;font-size:.85rem;font-weight:600;color:var(--text-muted);transition:all .25s;display:flex;align-items:center;gap:8px;font-family:inherit;}
        .tab:hover{background:var(--bg);color:var(--text);}
        .tab.active{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;box-shadow:0 4px 12px rgba(30,58,95,.3);}
        .tab-content{display:none;}.tab-content.active{display:block;animation:fadeIn .3s;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .card{background:var(--card);border-radius:var(--radius);padding:28px;box-shadow:var(--shadow);margin-bottom:20px;border:1px solid var(--border-light);}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px;}
        .card-title{font-size:1.15rem;font-weight:700;display:flex;align-items:center;gap:10px;color:var(--primary);}
        .card-title .icon{width:38px;height:38px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1.1rem;}
        .card-title .icon.blue{background:var(--accent-soft);}
        .card-title .icon.red{background:var(--red-pastel);}
        .card-title .icon.green{background:#dcfce7;}
        .card-title .icon.purple{background:var(--purple-soft);}
        .card-title .icon.orange{background:var(--orange-soft);}
        .week-selector{display:flex;align-items:center;gap:10px;background:var(--bg-warm);padding:10px 18px;border-radius:var(--radius-sm);border:1px solid var(--border);flex-wrap:wrap;}
        .week-selector label{font-weight:600;color:var(--text-sec);font-size:.85rem;}
        .week-selector input,.week-selector select,.filter-bar select,.filter-bar input{padding:8px 14px;border:1.5px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem;background:#fff;color:var(--text);font-family:inherit;}
        .week-selector input:focus,.week-selector select:focus,.filter-bar select:focus,.filter-bar input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.1);}
        .filter-bar{display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap;}
        .filter-bar select,.filter-bar input{min-width:180px;}
        .bulk-actions{display:flex;gap:8px;flex-wrap:wrap;}
        .table-container{overflow-x:auto;border-radius:var(--radius-md);border:1px solid var(--border);}
        table{width:100%;border-collapse:collapse;font-size:.87rem;}
        thead th{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;padding:14px 16px;text-align:left;font-weight:600;white-space:nowrap;font-size:.82rem;text-transform:uppercase;}
        thead th:first-child{border-radius:var(--radius-md) 0 0 0;}thead th:last-child{border-radius:0 var(--radius-md) 0 0;}
        tbody tr{transition:background .15s;}tbody tr:hover{background:var(--primary-soft);}tbody tr:nth-child(even){background:var(--bg-warm);}tbody tr:nth-child(even):hover{background:var(--primary-soft);}
        td{padding:12px 16px;border-bottom:1px solid var(--border-light);vertical-align:middle;}
        .status-btn{padding:5px 14px;border:2px solid var(--border);border-radius:20px;cursor:pointer;font-size:.76rem;font-weight:600;transition:all .2s;background:#fff;white-space:nowrap;font-family:inherit;}
        .status-btn.present,.status-btn.good,.status-btn.delivered,.status-btn.bueno{background:#dcfce7;border-color:#22c55e;color:#166534;}
        .status-btn.absent,.status-btn.bad,.status-btn.not-delivered,.status-btn.malo{background:var(--red-pastel);border-color:var(--red);color:var(--red-dark);}
        .status-btn.justified,.status-btn.regular,.status-btn.late{background:#fef3c7;border-color:var(--orange);color:#92400e;}
        .email-btn{width:34px;height:34px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:.95rem;transition:all .2s;}
        .email-btn:hover{transform:scale(1.1);}
        .email-btn.disabled{opacity:.25;pointer-events:none;}
        .edit-email-btn{width:28px;height:28px;border-radius:8px;border:1.5px solid var(--border);background:#fff;color:var(--text-sec);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:.8rem;transition:all .2s;}
        .edit-email-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-soft);}
        .note-input{width:130px;padding:6px 10px;border:1.5px solid var(--border);border-radius:var(--radius-xs);font-size:.8rem;font-family:inherit;}
        .note-input:focus{outline:none;border-color:var(--accent);}
        .upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:50px 40px;text-align:center;cursor:pointer;background:linear-gradient(135deg,var(--bg-warm),var(--accent-soft));transition:all .3s;}
        .upload-zone:hover,.upload-zone.dragover{border-color:var(--accent);background:linear-gradient(135deg,var(--accent-soft),#c7d2fe);}
        .upload-zone .icon{font-size:3.5rem;margin-bottom:12px;}
        .upload-zone h3{font-size:1.15rem;color:var(--primary);font-weight:700;}
        .upload-zone p{color:var(--text-sec);}
        .upload-zone input[type="file"]{display:none;}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:20px;}
        .stat-card{background:var(--card);border-radius:var(--radius-md);padding:20px;text-align:center;box-shadow:0 1px 2px rgba(0,0,0,.05);border:1px solid var(--border-light);position:relative;overflow:hidden;}
        .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;}
        .stat-card.blue::before{background:linear-gradient(90deg,var(--primary),var(--accent));}
        .stat-card.green::before{background:linear-gradient(90deg,#22c55e,#10b981);}
        .stat-card.red::before{background:linear-gradient(90deg,var(--red),#ef4444);}
        .stat-card.yellow::before{background:linear-gradient(90deg,var(--orange),#eab308);}
        .stat-card.purple::before{background:linear-gradient(90deg,var(--purple),#8b5cf6);}
        .stat-number{font-size:2rem;font-weight:800;}
        .stat-label{font-size:.78rem;color:var(--text-muted);margin-top:4px;font-weight:600;text-transform:uppercase;}
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,.6);backdrop-filter:blur(4px);z-index:200;justify-content:center;align-items:center;padding:20px;}
        .modal-overlay.active{display:flex;}
        .modal{background:#fff;border-radius:var(--radius);padding:32px;max-width:620px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:modalIn .3s;}
        @keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
        .modal h2{margin-bottom:20px;display:flex;align-items:center;gap:10px;color:var(--primary);font-size:1.2rem;}
        .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px;flex-wrap:wrap;}
        .form-group{margin-bottom:16px;}.form-group label{font-weight:600;display:block;margin-bottom:6px;font-size:.85rem;}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.9rem;font-family:inherit;background:#fff;}
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:var(--accent);}
        .form-group textarea{min-height:110px;resize:vertical;}
        .form-group small{color:var(--text-muted);font-size:.75rem;margin-top:4px;display:block;}
        .toast-container{position:fixed;bottom:24px;right:24px;z-index:300;display:flex;flex-direction:column;gap:10px;}
        .toast{padding:14px 22px;border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px;animation:slideIn .3s;font-weight:600;font-size:.88rem;color:#fff;max-width:380px;}
        .toast.success{background:linear-gradient(135deg,#059669,#10b981);}
        .toast.error{background:linear-gradient(135deg,var(--red-dark),var(--red));}
        .toast.info{background:linear-gradient(135deg,var(--primary),var(--accent));}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .student-name{font-weight:600;}.student-course{font-size:.75rem;color:var(--primary);background:var(--primary-soft);padding:3px 10px;border-radius:12px;display:inline-block;font-weight:600;}
        .inline-flex{display:flex;gap:6px;align-items:center;}
        .week-history{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
        .week-chip{padding:6px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:20px;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit;color:var(--text-sec);}
        .week-chip:hover,.week-chip.active{background:var(--primary);color:#fff;border-color:var(--primary);}
        .empty-state{text-align:center;padding:50px 20px;color:var(--text-muted);}.empty-state .icon{font-size:3.5rem;margin-bottom:12px;}.empty-state h3{font-size:1.1rem;color:var(--text-sec);}
        .summary-list{list-style:none;padding:0;}.summary-list li{padding:10px 14px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;}.summary-list li:hover{background:var(--bg-warm);}.summary-list li:last-child{border-bottom:none;}
        .email-ok{color:#059669;font-size:.82rem;}.email-missing{color:var(--red);font-style:italic;font-size:.82rem;}
        .debug-preview{background:var(--bg-warm);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-top:16px;font-size:.82rem;max-height:200px;overflow-y:auto;}.debug-preview code{background:var(--accent-soft);padding:2px 6px;border-radius:4px;}
        .course-filter-section{background:var(--bg-warm);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 18px;margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
        .course-filter-section label{font-weight:600;color:var(--primary);font-size:.88rem;white-space:nowrap;}
        .course-filter-section select,.course-filter-section input{padding:8px 14px;border:1.5px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem;font-family:inherit;background:#fff;min-width:200px;}
        .day-tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.7rem;font-weight:600;margin:1px 2px;}
        .day-tag.absent-day{background:var(--red-pastel);color:var(--red-dark);}.day-tag.justified-day{background:#fef3c7;color:#92400e;}.day-tag.present-day{background:#dcfce7;color:#166534;}
        .gravity-btn{padding:6px 16px;border:2px solid var(--border);border-radius:20px;cursor:pointer;font-size:.78rem;font-weight:600;background:#fff;font-family:inherit;transition:all .2s;}
        .gravity-btn.active-leve{background:#dcfce7;border-color:#22c55e;color:#166534;transform:scale(1.05);}
        .gravity-btn.active-moderada{background:#fef3c7;border-color:var(--orange);color:#92400e;transform:scale(1.05);}
        .gravity-btn.active-grave{background:var(--red-pastel);border-color:var(--red);color:var(--red-dark);transform:scale(1.05);}
        .gravity-btn:not([class*="active"]){opacity:.5;}
        .director-preview{background:var(--bg-warm);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;max-height:280px;overflow-y:auto;font-size:.8rem;white-space:pre-wrap;line-height:1.6;font-family:'Courier New',monospace;}
        .attach-info{background:var(--accent-soft);border:1px solid var(--accent-light);border-radius:var(--radius-sm);padding:14px 18px;margin-top:12px;font-size:.82rem;color:var(--primary);display:flex;gap:10px;line-height:1.5;}
        .step-list{margin:8px 0;padding-left:20px;}.step-list li{margin-bottom:4px;}
        .behav-type-tag{display:inline-block;padding:3px 10px;border-radius:12px;font-size:.72rem;font-weight:600;margin:2px;}
        .behav-type-tag.grave{background:var(--red-pastel);color:var(--red-dark);}
        .behav-type-tag.moderada{background:var(--orange-soft);color:#92400e;}
        .behav-type-tag.leve{background:#dcfce7;color:#166534;}
        .gmail-badge{display:inline-flex;align-items:center;gap:4px;background:#ea4335;color:#fff;padding:2px 8px;border-radius:10px;font-size:.7rem;font-weight:700;}
        @media(max-width:768px){.header-top{flex-direction:column;text-align:center;}.tabs{justify-content:center;}.tab{padding:9px 14px;font-size:.8rem;}.card{padding:18px;}.card-header{flex-direction:column;align-items:flex-start;}.week-selector{width:100%;}.filter-bar{flex-direction:column;}.filter-bar select,.filter-bar input{width:100%;min-width:auto;}td,th{padding:8px 10px;font-size:.78rem;}.stats-grid{grid-template-columns:repeat(2,1fr);}}
    </style>
</head>
<body>

<div class="header"><div class="header-top">
    <div class="header-brand"><div class="header-logo">ğŸ“</div><div class="header-info"><h1>Control de Alumnado</h1><p>Centro AcadÃ©mico Privado de InglÃ©s Â· Sevilla, 56 BailÃ©n</p></div></div>
    <div class="header-actions">
        <button class="btn btn-outline-white btn-sm" onclick="exportAllData()">ğŸ’¾ Exportar</button>
        <button class="btn btn-outline-white btn-sm" onclick="importAllData()">ğŸ“‚ Importar</button>
        <button class="btn btn-outline-white btn-sm" onclick="openDirectorEmailModal()" style="border-color:rgba(147,197,253,.7);color:#93c5fd;">ğŸ‘” Email Director</button>
        <button class="btn btn-outline-white btn-sm" onclick="confirmClearAll()" style="border-color:rgba(252,165,165,.5);color:#fca5a5;">ğŸ—‘ï¸ Borrar</button>
        <input type="file" id="importDataInput" accept=".json" style="display:none" onchange="handleImportData(event)">
    </div>
</div></div>

<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="switchTab('students',this)">ğŸ‘¥ Alumnos</button>
        <button class="tab" onclick="switchTab('attendance',this)">ğŸ“‹ Asistencia</button>
        <button class="tab" onclick="switchTab('behavior',this)">â­ Trabajo</button>
        <button class="tab" onclick="switchTab('conduct',this)">ğŸš¦ Comportamiento</button>
        <button class="tab" onclick="switchTab('writings',this)">âœï¸ Writings</button>
        <button class="tab" onclick="switchTab('reports',this)">ğŸ“Š Informes</button>
    </div>

    <div id="tab-students" class="tab-content active">
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="icon blue">ğŸ‘¥</span> Alumnos</div><button class="btn btn-primary btn-sm" onclick="showAddModal()">â• AÃ±adir</button></div>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('excelInput').click()">
                <div class="icon">ğŸ“</div><h3>Importar Excel</h3><p>Columnas: <strong>Nombre | Curso | Email Padre</strong></p>
                <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" onchange="handleXL(event)">
            </div>
            <div class="course-filter-section" style="margin-top:20px;"><label>ğŸ“š Filtrar:</label><select id="studentsCourseFilter" onchange="renderStudents()"><option value="">Todos</option></select><input type="text" id="studentsSearch" placeholder="ğŸ” Buscar..." oninput="renderStudents()"></div>
            <div id="studentsList" style="margin-top:16px;"></div>
        </div>
    </div>

    <div id="tab-attendance" class="tab-content"><div class="card">
        <div class="card-header"><div class="card-title"><span class="icon blue">ğŸ“‹</span> Asistencia</div><div class="week-selector"><label>ğŸ“…</label><input type="week" id="attendanceWeek" onchange="loadCat('attendance')"><label>ğŸ“†</label><input type="date" id="attendanceDay" onchange="loadCat('attendance')"></div></div>
        <div class="filter-bar"><select id="attendanceCourseFilter" onchange="loadCat('attendance')"><option value="">Todos</option></select><input type="text" id="attendanceSearch" placeholder="ğŸ”" oninput="loadCat('attendance')"><div class="bulk-actions"><button class="btn btn-success btn-sm" onclick="setAll('attendance','present')">âœ… Todos</button><button class="btn btn-warning btn-sm" onclick="genPDF('attendance')">ğŸ“„ PDF</button></div></div>
        <div id="attendanceStats" class="stats-grid"></div><div class="table-container" id="attendanceTable"></div>
    </div><div class="card"><div class="card-title" style="margin-bottom:10px;">ğŸ“… Historial</div><div id="attendanceHistory" class="week-history"></div></div></div>

    <div id="tab-behavior" class="tab-content"><div class="card">
        <div class="card-header"><div class="card-title"><span class="icon green">â­</span> Trabajo en Clase</div><div class="week-selector"><label>ğŸ“…</label><input type="week" id="behaviorWeek" onchange="loadCat('behavior')"><label>ğŸ“†</label><input type="date" id="behaviorDay" onchange="loadCat('behavior')"></div></div>
        <div class="filter-bar"><select id="behaviorCourseFilter" onchange="loadCat('behavior')"><option value="">Todos</option></select><input type="text" id="behaviorSearch" placeholder="ğŸ”" oninput="loadCat('behavior')"><div class="bulk-actions"><button class="btn btn-success btn-sm" onclick="setAll('behavior','good')">âœ… Todos</button><button class="btn btn-warning btn-sm" onclick="genPDF('behavior')">ğŸ“„ PDF</button></div></div>
        <div id="behaviorStats" class="stats-grid"></div><div class="table-container" id="behaviorTable"></div>
    </div><div class="card"><div class="card-title" style="margin-bottom:10px;">ğŸ“… Historial</div><div id="behaviorHistory" class="week-history"></div></div></div>

    <div id="tab-conduct" class="tab-content"><div class="card">
        <div class="card-header"><div class="card-title"><span class="icon purple">ğŸš¦</span> Comportamiento</div><div class="week-selector"><label>ğŸ“…</label><input type="week" id="conductWeek" onchange="loadCat('conduct')"><label>ğŸ“†</label><input type="date" id="conductDay" onchange="loadCat('conduct')"></div></div>
        <div class="filter-bar"><select id="conductCourseFilter" onchange="loadCat('conduct')"><option value="">Todos</option></select><input type="text" id="conductSearch" placeholder="ğŸ”" oninput="loadCat('conduct')"><div class="bulk-actions"><button class="btn btn-success btn-sm" onclick="setAll('conduct','bueno')">âœ… Todos</button><button class="btn btn-warning btn-sm" onclick="genPDF('conduct')">ğŸ“„ PDF</button></div></div>
        <div id="conductStats" class="stats-grid"></div><div class="table-container" id="conductTable"></div>
    </div><div class="card"><div class="card-title" style="margin-bottom:10px;">ğŸ“… Historial</div><div id="conductHistory" class="week-history"></div></div></div>

    <div id="tab-writings" class="tab-content"><div class="card">
        <div class="card-header"><div class="card-title"><span class="icon red">âœï¸</span> Writings</div><div class="week-selector"><label>ğŸ“…</label><input type="week" id="writingsWeek" onchange="loadCat('writings')"><label>ğŸ“†</label><input type="date" id="writingsDay" onchange="loadCat('writings')"></div></div>
        <div class="filter-bar"><select id="writingsCourseFilter" onchange="loadCat('writings')"><option value="">Todos</option></select><input type="text" id="writingsSearch" placeholder="ğŸ”" oninput="loadCat('writings')"><div class="bulk-actions"><button class="btn btn-success btn-sm" onclick="setAll('writings','delivered')">âœ… Todos</button><button class="btn btn-warning btn-sm" onclick="genPDF('writings')">ğŸ“„ PDF</button></div></div>
        <div id="writingsStats" class="stats-grid"></div><div class="table-container" id="writingsTable"></div>
    </div><div class="card"><div class="card-title" style="margin-bottom:10px;">ğŸ“… Historial</div><div id="writingsHistory" class="week-history"></div></div></div>

    <div id="tab-reports" class="tab-content">
        <div class="card"><div class="card-header"><div class="card-title"><span class="icon blue">ğŸ“Š</span> Informes</div><div class="week-selector"><label>ğŸ“…</label><input type="week" id="reportsWeek" onchange="loadReports()"><select id="reportsCourseFilter" onchange="loadReports()"><option value="">Todos</option></select></div></div></div>
        <div class="stats-grid" id="reportStatsGrid"></div>
        <div class="card"><div class="card-title" style="margin-bottom:15px;"><span class="icon red">âŒ</span> Ausentes</div><div id="rAbsent"></div></div>
        <div class="card"><div class="card-title" style="margin-bottom:15px;"><span class="icon orange">â­</span> Mal Trabajo</div><div id="rWork"></div></div>
        <div class="card"><div class="card-title" style="margin-bottom:15px;"><span class="icon purple">ğŸš¦</span> Mal Comportamiento</div><div id="rConduct"></div></div>
        <div class="card"><div class="card-title" style="margin-bottom:15px;"><span class="icon red">ğŸ“</span> Sin Writing</div><div id="rWriting"></div></div>
        <div class="card"><div class="card-header"><div class="card-title"><span class="icon blue">ğŸ“„</span> Acciones</div></div>
            <div class="inline-flex" style="flex-wrap:wrap;gap:10px;">
                <button class="btn btn-primary" onclick="genFullReport()">ğŸ“„ PDF Completo</button>
                <button class="btn btn-danger" onclick="sendBulkEmails()">ğŸ“§ Emails Padres <span class="gmail-badge">Gmail</span></button>
                <button class="btn btn-warning" onclick="openDirectorEmailModal()">ğŸ‘” Director + PDF <span class="gmail-badge">Gmail</span></button>
            </div>
        </div>
    </div>
</div>

<!-- MODALES -->
<div class="modal-overlay" id="addStudentModal"><div class="modal"><h2>â• Alumno</h2><div class="form-group"><label>Nombre</label><input id="newName"></div><div class="form-group"><label>Curso</label><input id="newCourse"></div><div class="form-group"><label>Email Padre</label><input id="newEmail" type="email"></div><div class="modal-actions"><button class="btn btn-ghost btn-sm" onclick="closeModal('addStudentModal')">Cancelar</button><button class="btn btn-primary btn-sm" onclick="addStudent()">ğŸ’¾</button></div></div></div>

<div class="modal-overlay" id="editStudentModal"><div class="modal"><h2>âœï¸ Editar</h2><input type="hidden" id="editId"><div class="form-group"><label>Nombre</label><input id="editName"></div><div class="form-group"><label>Curso</label><input id="editCourse"></div><div class="form-group"><label>Email Padre</label><input id="editEmail" type="email"></div><div class="modal-actions"><button class="btn btn-ghost btn-sm" onclick="closeModal('editStudentModal')">Cancelar</button><button class="btn btn-primary btn-sm" onclick="saveEdit()">ğŸ’¾</button></div></div></div>

<div class="modal-overlay" id="emailModal"><div class="modal"><h2>ğŸ“§ Email <span class="gmail-badge">Gmail</span></h2><div class="form-group"><label>Para:</label><input id="emTo" readonly></div><div class="form-group"><label>Alumno:</label><input id="emStudent" readonly></div><div class="form-group"><label>Asunto:</label><input id="emSubject"></div><div class="form-group"><label>Mensaje:</label><textarea id="emBody"></textarea></div><div class="modal-actions"><button class="btn btn-ghost btn-sm" onclick="closeModal('emailModal')">Cancelar</button><button class="btn btn-primary btn-sm" onclick="doSendEmail()">ğŸ“§ Abrir Gmail</button></div></div></div>

<div class="modal-overlay" id="columnMapModal"><div class="modal"><h2>ğŸ“Š Columnas</h2><div class="form-group"><label>Nombre:</label><select id="mapNombre"></select></div><div class="form-group"><label>Curso:</label><select id="mapCurso"></select></div><div class="form-group"><label>Email:</label><select id="mapEmail"></select></div><div id="colPreview" class="debug-preview"></div><div class="modal-actions"><button class="btn btn-ghost btn-sm" onclick="closeModal('columnMapModal')">Cancelar</button><button class="btn btn-primary btn-sm" onclick="confirmMap()">âœ…</button></div></div></div>

<div class="modal-overlay" id="conductDetailModal"><div class="modal"><h2>ğŸ“ Comportamiento</h2><input type="hidden" id="cdId"><input type="hidden" id="cdWeek"><input type="hidden" id="cdDay"><div class="form-group"><label id="cdName" style="font-size:1rem;color:var(--primary);"></label></div><div class="form-group"><label>Tipo:</label><select id="cdType"><option value="disruptive">ğŸ—£ï¸ Disruptivo</option><option value="no-work">ğŸ“µ No trabaja</option><option value="no-material">ğŸ’ Sin material</option><option value="disrespect">â›” Irrespetuoso</option><option value="phone">ğŸ“± MÃ³vil</option><option value="late-class">â° Llega tarde</option><option value="other">ğŸ“‹ Otro</option></select></div><div class="form-group"><label>DescripciÃ³n:</label><textarea id="cdDesc"></textarea></div><div class="form-group"><label>Gravedad:</label><div class="inline-flex" style="gap:8px;flex-wrap:wrap;"><button class="gravity-btn" id="gL" onclick="setGrav('leve')">ğŸŸ¡ Leve</button><button class="gravity-btn" id="gM" onclick="setGrav('moderada')">ğŸŸ  Moderada</button><button class="gravity-btn" id="gG" onclick="setGrav('grave')">ğŸ”´ Grave</button></div></div><div class="form-group"><label><input type="checkbox" id="cdNotifyP" style="margin-right:6px;">Notificar padre <span class="gmail-badge">Gmail</span></label></div><div class="modal-actions"><button class="btn btn-ghost btn-sm" onclick="closeModal('conductDetailModal')">Cancelar</button><button class="btn btn-primary btn-sm" onclick="saveConductDetail()">ğŸ’¾</button></div></div></div>

<div class="modal-overlay" id="directorEmailModal"><div class="modal" style="max-width:700px;"><h2>ğŸ‘” Director <span class="gmail-badge">Gmail</span></h2><div class="form-group"><label>Email:</label><input id="dirEmail" type="email"><small>Por defecto: capinglesb@gmail.com</small></div><div class="form-group"><label>Semana:</label><input type="week" id="dirWeek" onchange="refreshDirPreview()"></div><div class="form-group"><label>Curso:</label><select id="dirCourse" onchange="refreshDirPreview()"><option value="">Todos</option></select></div><div class="form-group"><label>Vista previa:</label><div id="dirPreview" class="director-preview"></div></div><div class="form-group"><label>Extra:</label><textarea id="dirExtra" style="min-height:70px;"></textarea></div><div class="attach-info"><span style="font-size:1.5rem;">ğŸ“</span><div><strong>Adjuntar PDF:</strong><ol class="step-list"><li>Pulsa "ğŸ“„ PDF + Gmail"</li><li>Se descarga el PDF</li><li>Se abre Gmail</li><li>Adjunta el PDF descargado</li></ol></div></div><div class="modal-actions"><button class="btn btn-ghost btn-sm" onclick="closeModal('directorEmailModal')">Cancelar</button><button class="btn btn-ghost btn-sm" onclick="refreshDirPreview()">ğŸ”„</button><button class="btn btn-primary btn-sm" onclick="sendDirOnly()">ğŸ“§ Solo Gmail</button><button class="btn btn-success" onclick="sendDirPDF()">ğŸ“„ PDF + Gmail</button></div></div></div>

<div class="toast-container" id="toastContainer"></div>

<script>
let S=JSON.parse(localStorage.getItem('students')||'[]');
let W=JSON.parse(localStorage.getItem('weeklyData')||'{}');
let pendingXL=null;
const CE="Centro AcadÃ©mico Privado de InglÃ©s",CD="Sevilla, 56 Â· BailÃ©n",CF="Control de Alumnado - Centro AcadÃ©mico Privado de InglÃ©s Sevilla, 56 BailÃ©n",DE="capinglesb@gmail.com";
const CATS=['attendance','behavior','conduct','writings'];
const CT={attendance:'ASISTENCIA',behavior:'TRABAJO EN CLASE',conduct:'COMPORTAMIENTO',writings:'WRITINGS'};
const CO={
    attendance:[{v:'present',c:'present',l:'âœ… Presente'},{v:'absent',c:'absent',l:'âŒ Ausente'},{v:'justified',c:'justified',l:'ğŸ“‹ Justificada'}],
    behavior:[{v:'good',c:'good',l:'âœ… Bien'},{v:'regular',c:'regular',l:'âš ï¸ Regular'},{v:'bad',c:'bad',l:'âŒ Mal'}],
    conduct:[{v:'bueno',c:'bueno',l:'âœ… Bueno'},{v:'regular',c:'regular',l:'âš ï¸ Regular'},{v:'malo',c:'malo',l:'âŒ Malo'}],
    writings:[{v:'delivered',c:'delivered',l:'âœ… Entregado'},{v:'late',c:'late',l:'â° Tarde'},{v:'not-delivered',c:'not-delivered',l:'âŒ No entregado'}]
};
const CD2={attendance:'present',behavior:'good',conduct:'bueno',writings:'delivered'};
const CN={attendance:['absent'],behavior:['bad','regular'],conduct:['malo','regular'],writings:['not-delivered','late']};
const SL={present:'Presente',absent:'Ausente',justified:'Justificada',good:'Bien',regular:'Regular',bad:'Mal',bueno:'Bueno',malo:'Malo',delivered:'Entregado',late:'Tarde','not-delivered':'No entregado'};
const TL={disruptive:'ğŸ—£ï¸ Disruptivo','no-work':'ğŸ“µ No trabaja','no-material':'ğŸ’ Sin material',disrespect:'â›” Irrespetuoso',phone:'ğŸ“± MÃ³vil','late-class':'â° Tarde',other:'ğŸ“‹ Otro'};
const TLS={disruptive:'Disruptivo','no-work':'No trabaja','no-material':'Sin material',disrespect:'Irrespetuoso',phone:'MÃ³vil','late-class':'Tarde',other:'Otro'};

// === GMAIL HELPER ===
function gmail(to,subject,body){
    window.open(`https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`,'_blank');
}

function ss(){localStorage.setItem('students',JSON.stringify(S));}
function sw(){localStorage.setItem('weeklyData',JSON.stringify(W));}
function migrate(){let c=false;Object.keys(W).forEach(w=>{CATS.forEach(cat=>{if(W[w][cat]){const fk=Object.keys(W[w][cat])[0];if(fk&&W[w][cat][fk]&&W[w][cat][fk].status){W[w][cat]={"sin_fecha":W[w][cat]};c=true;}}});});if(c)sw();}

function cw(){const d=new Date(),y=d.getFullYear(),o=new Date(y,0,1),days=Math.floor((d-o)/86400000),wn=Math.ceil((days+o.getDay()+1)/7);return`${y}-W${String(wn).padStart(2,'0')}`;}
function today(){return new Date().toISOString().slice(0,10);}
function fds(ds){if(!ds||ds==='sin_fecha')return'Sin fecha';try{const p=ds.split('-');return`${p[2]}/${p[1]}/${p[0]}`;}catch(e){return ds;}}
function dn(ds){if(!ds||ds==='sin_fecha')return'Sin fecha';try{return new Date(ds+'T12:00:00').toLocaleDateString('es-ES',{weekday:'long',day:'numeric',month:'short'});}catch(e){return ds;}}
function wdr(w){if(!w)return'';try{const[y,wk]=w.split('-W');const s=new Date(y,0,1+(wk-1)*7);s.setDate(s.getDate()-s.getDay()+1);const e=new Date(s);e.setDate(s.getDate()+6);const f=d=>`${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;return`${f(s)} - ${f(e)}`;}catch(e){return w;}}
function toast(m,t='info'){const c=document.getElementById('toastContainer'),el=document.createElement('div');el.className=`toast ${t}`;el.innerHTML=m;c.appendChild(el);setTimeout(()=>{el.style.opacity='0';setTimeout(()=>el.remove(),300);},3500);}
function courses(){return[...new Set(S.map(s=>s.course||'Sin curso'))].sort();}
function updFilters(){const ids=['studentsCourseFilter','attendanceCourseFilter','behaviorCourseFilter','conductCourseFilter','writingsCourseFilter','reportsCourseFilter','dirCourse'];const cs=courses();ids.forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Todos</option>';cs.forEach(c=>{el.innerHTML+=`<option value="${c}" ${c===cur?'selected':''}>${c}</option>`;});});}
function gid(){return Date.now().toString(36)+Math.random().toString(36).substr(2);}

function switchTab(n,b){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));b.classList.add('active');document.getElementById(`tab-${n}`).classList.add('active');if(CATS.includes(n)){const w=document.getElementById(`${n}Week`),d=document.getElementById(`${n}Day`);if(!w.value)w.value=cw();if(!d.value)d.value=today();loadCat(n);loadHist(n);}if(n==='reports'){if(!document.getElementById('reportsWeek').value)document.getElementById('reportsWeek').value=cw();loadReports();}if(n==='students')renderStudents();}

// EXCEL
const uz=document.getElementById('uploadZone');uz.addEventListener('dragover',e=>{e.preventDefault();uz.classList.add('dragover');});uz.addEventListener('dragleave',()=>uz.classList.remove('dragover'));uz.addEventListener('drop',e=>{e.preventDefault();uz.classList.remove('dragover');if(e.dataTransfer.files[0])procXL(e.dataTransfer.files[0]);});
function handleXL(e){if(e.target.files[0])procXL(e.target.files[0]);e.target.value='';}
function nk(k){return k.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,'');}
function ad(cols,p){for(const c of cols){const n=nk(c);for(const x of p){if(n.includes(x))return c;}}return'';}
function procXL(file){const r=new FileReader();r.onload=function(e){try{const d=new Uint8Array(e.target.result),wb=XLSX.read(d,{type:'array'}),json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''});if(!json.length){toast('âŒ VacÃ­o','error');return;}const cols=Object.keys(json[0]);pendingXL=json;const an=ad(cols,['nombre','name','alumno']),ac=ad(cols,['curso','course','clase','grupo']),ae=ad(cols,['email','correo','mail','padre','madre']);['mapNombre','mapCurso','mapEmail'].forEach((id,i)=>{const sel=document.getElementById(id),auto=[an,ac,ae][i];sel.innerHTML='<option value="">--</option>';cols.forEach(c=>{sel.innerHTML+=`<option value="${c}" ${c===auto?'selected':''}>${c}</option>`;});});let prev=`<p>${cols.map(c=>`<code>${c}</code>`).join(' ')}</p>`;json.slice(0,3).forEach((r,i)=>{prev+=`<p>${cols.map(c=>`<code>${r[c]}</code>`).join(' | ')}</p>`;});document.getElementById('colPreview').innerHTML=prev;document.getElementById('columnMapModal').classList.add('active');}catch(err){toast('âŒ','error');}};r.readAsArrayBuffer(file);}
function confirmMap(){const cn=document.getElementById('mapNombre').value,cc=document.getElementById('mapCurso').value,ce=document.getElementById('mapEmail').value;if(!cn){toast('âš ï¸','error');return;}let count=0;pendingXL.forEach(row=>{const name=(row[cn]||'').toString().trim(),course=cc?(row[cc]||'').toString().trim():'',email=ce?(row[ce]||'').toString().trim():'';if(name){const ex=S.find(s=>s.name.toLowerCase()===name.toLowerCase()&&s.course.toLowerCase()===course.toLowerCase());if(!ex){S.push({id:gid(),name,course,email});count++;}else if(!ex.email&&email)ex.email=email;}});pendingXL=null;ss();updFilters();renderStudents();closeModal('columnMapModal');toast(`âœ… ${count} importados`,'success');}

// STUDENTS
function renderStudents(){const c=document.getElementById('studentsList'),cf=document.getElementById('studentsCourseFilter').value,sr=(document.getElementById('studentsSearch').value||'').toLowerCase();let f=S.filter(s=>{if(cf&&(s.course||'Sin curso')!==cf)return false;if(sr&&!s.name.toLowerCase().includes(sr))return false;return true;});if(!S.length){c.innerHTML=`<div class="empty-state"><div class="icon">ğŸ‘¥</div><h3>Sin alumnos</h3></div>`;return;}if(!f.length){c.innerHTML=`<div class="empty-state"><div class="icon">ğŸ”</div><h3>Sin resultados</h3></div>`;return;}const g={};f.forEach(s=>{const k=s.course||'Sin curso';if(!g[k])g[k]=[];g[k].push(s);});const we=f.filter(s=>s.email).length;let h=`<div class="stats-grid"><div class="stat-card blue"><div class="stat-number">${f.length}</div><div class="stat-label">Total</div></div><div class="stat-card green"><div class="stat-number">${Object.keys(g).length}</div><div class="stat-label">Cursos</div></div><div class="stat-card blue"><div class="stat-number">${we}</div><div class="stat-label">Con Email</div></div><div class="stat-card red"><div class="stat-number">${f.length-we}</div><div class="stat-label">Sin Email</div></div></div>`;Object.keys(g).sort().forEach(k=>{const l=g[k].sort((a,b)=>a.name.localeCompare(b.name));h+=`<div style="margin-bottom:20px;"><h3 style="color:var(--primary);margin-bottom:10px;">ğŸ“š ${k} <span class="student-course">${l.length}</span></h3><div class="table-container"><table><thead><tr><th>#</th><th>Nombre</th><th>Email</th><th>Acciones</th></tr></thead><tbody>`;l.forEach((s,i)=>{h+=`<tr><td>${i+1}</td><td><span class="student-name">${s.name}</span></td><td>${s.email?`<span class="email-ok">âœ… ${s.email}</span>`:`<span class="email-missing">âŒ</span>`}</td><td><div class="inline-flex"><button class="email-btn ${!s.email?'disabled':''}" onclick="openEmail('${s.id}')">ğŸ“§</button><button class="edit-email-btn" onclick="openEdit('${s.id}')">âœï¸</button><button class="edit-email-btn" onclick="delStudent('${s.id}')" style="color:var(--red);">ğŸ—‘ï¸</button></div></td></tr>`;});h+='</tbody></table></div></div>';});c.innerHTML=h;}
function showAddModal(){['newName','newCourse','newEmail'].forEach(id=>document.getElementById(id).value='');document.getElementById('addStudentModal').classList.add('active');}
function addStudent(){const n=document.getElementById('newName').value.trim();if(!n){toast('âŒ','error');return;}S.push({id:gid(),name:n,course:document.getElementById('newCourse').value.trim(),email:document.getElementById('newEmail').value.trim()});ss();updFilters();renderStudents();closeModal('addStudentModal');toast('âœ…','success');}
function openEdit(id){const s=S.find(x=>x.id===id);if(!s)return;document.getElementById('editId').value=id;document.getElementById('editName').value=s.name;document.getElementById('editCourse').value=s.course;document.getElementById('editEmail').value=s.email||'';document.getElementById('editStudentModal').classList.add('active');}
function saveEdit(){const id=document.getElementById('editId').value,s=S.find(x=>x.id===id);if(!s)return;const n=document.getElementById('editName').value.trim();if(!n){toast('âŒ','error');return;}s.name=n;s.course=document.getElementById('editCourse').value.trim();s.email=document.getElementById('editEmail').value.trim();ss();updFilters();renderStudents();closeModal('editStudentModal');toast('âœ…','success');}
function delStudent(id){const s=S.find(x=>x.id===id);if(s&&confirm(`Â¿Eliminar "${s.name}"?`)){S=S.filter(x=>x.id!==id);ss();renderStudents();toast('ğŸ—‘ï¸','info');}}

// DATA
function gw(cat){return document.getElementById(`${cat}Week`).value;}
function gd(cat){return document.getElementById(`${cat}Day`).value||today();}
function ens(w,c,d){if(!W[w])W[w]={};if(!W[w][c])W[w][c]={};if(!W[w][c][d])W[w][c][d]={};}
function gst(w,c,d,id){if(!W[w]||!W[w][c]||!W[w][c][d]||!W[w][c][d][id])return{status:CD2[c],note:''};return W[w][c][d][id];}
function sst(w,c,d,id,st,note){ens(w,c,d);W[w][c][d][id]={status:st,note:note||'',ts:new Date().toISOString()};sw();}
function wdays(w,c){if(!W[w]||!W[w][c])return[];return Object.keys(W[w][c]).sort();}
function wsum(w,c,id){const days=wdays(w,c),r=[];days.forEach(d=>{const data=gst(w,c,d,id);if(data.status!==CD2[c])r.push({day:d,status:data.status,note:data.note});});return r;}

function loadCat(cat){const w=gw(cat),d=gd(cat);if(!w)return;const cf=document.getElementById(`${cat}CourseFilter`).value,sr=document.getElementById(`${cat}Search`).value.toLowerCase();let f=S.filter(s=>{if(cf&&s.course!==cf)return false;if(sr&&!s.name.toLowerCase().includes(sr))return false;return true;});f.sort((a,b)=>a.course.localeCompare(b.course)||a.name.localeCompare(b.name));renderTable(cat,w,d,f);renderStats(cat,w,d,f);loadHist(cat);}

function renderTable(cat,w,day,list){const c=document.getElementById(`${cat}Table`);if(!list.length){c.innerHTML=`<div class="empty-state"><div class="icon">ğŸ“­</div><h3>Sin alumnos</h3></div>`;return;}const opts=CO[cat];let h=`<table><thead><tr><th>#</th><th>Alumno</th><th>Curso</th><th>Estado (${dn(day)})</th><th>Notas</th><th>Semana</th><th>Acciones</th></tr></thead><tbody>`;list.forEach((s,i)=>{const st=gst(w,cat,day,s.id);const sum=wsum(w,cat,s.id);h+=`<tr><td>${i+1}</td><td><span class="student-name">${s.name}</span></td><td><span class="student-course">${s.course}</span></td><td><div class="inline-flex">`;opts.forEach(o=>{h+=`<button class="status-btn ${st.status===o.v?o.c:''}" style="${st.status!==o.v?'opacity:.35':''}" onclick="toggle('${cat}','${w}','${day}','${s.id}','${o.v}')">${o.l}</button>`;});h+=`</div></td><td><input class="note-input" value="${(st.note||'').replace(/"/g,'&quot;')}" placeholder="Nota..." onchange="updNote('${cat}','${w}','${day}','${s.id}',this.value)"></td><td>`;if(sum.length)sum.forEach(x=>{const cls=CN[cat].includes(x.status)?'absent-day':x.status==='justified'?'justified-day':'present-day';h+=`<span class="day-tag ${cls}">${dn(x.day)}</span> `;});else h+=`<span style="color:var(--text-muted);font-size:.75rem;">OK</span>`;h+=`</td><td><div class="inline-flex"><button class="email-btn ${!s.email?'disabled':''}" onclick="openEmail('${s.id}')">ğŸ“§</button><button class="edit-email-btn" onclick="openEdit('${s.id}')">âœï¸</button>`;if(cat==='conduct'){const hd=getCDet(w,day,s.id);let ds='';if(hd){if(hd.gravity==='grave')ds='color:var(--red);border-color:var(--red);background:var(--red-pastel);';else if(hd.gravity==='moderada')ds='color:#d97706;border-color:var(--orange);background:var(--orange-soft);';else ds='color:#059669;border-color:#22c55e;background:#dcfce7;';}h+=`<button class="edit-email-btn" onclick="openCDetail('${s.id}','${w}','${day}')" title="Detalle" style="${ds}">ğŸ“</button>`;}h+=`</div></td></tr>`;});c.innerHTML=h+'</tbody></table>';}

function toggle(cat,w,d,id,st){const c=gst(w,cat,d,id);sst(w,cat,d,id,st,c.note);loadCat(cat);}
function updNote(cat,w,d,id,n){const c=gst(w,cat,d,id);sst(w,cat,d,id,c.status,n);}
function setAll(cat,st){const w=gw(cat),d=gd(cat);if(!w)return;const cf=document.getElementById(`${cat}CourseFilter`).value;S.forEach(s=>{if(cf&&s.course!==cf)return;sst(w,cat,d,s.id,st,gst(w,cat,d,s.id).note);});loadCat(cat);toast('âœ…','success');}
function renderStats(cat,w,d,list){const c=document.getElementById(`${cat}Stats`);const opts=CO[cat];const counts={};opts.forEach(o=>counts[o.v]=0);list.forEach(s=>{const st=gst(w,cat,d,s.id);if(counts[st.status]!==undefined)counts[st.status]++;});const colors={0:'green',1:'red',2:'yellow'};let h=`<div class="stat-card blue"><div class="stat-number">${list.length}</div><div class="stat-label">Total</div></div>`;opts.forEach((o,i)=>{h+=`<div class="stat-card ${colors[i]}"><div class="stat-number">${counts[o.v]}</div><div class="stat-label">${o.l}</div></div>`;});c.innerHTML=h;}
function loadHist(cat){const c=document.getElementById(`${cat}History`),cur=gw(cat),weeks=Object.keys(W).filter(w=>W[w][cat]).sort().reverse();if(!weeks.length){c.innerHTML='<p style="color:var(--text-muted);">Sin datos</p>';return;}c.innerHTML=weeks.map(w=>`<button class="week-chip ${w===cur?'active':''}" onclick="jumpW('${cat}','${w}')">ğŸ“… ${w} (${wdays(w,cat).length}d)</button>`).join('');}
function jumpW(cat,w){document.getElementById(`${cat}Week`).value=w;loadCat(cat);}

// EMAIL via GMAIL
function openEmail(id){const s=S.find(x=>x.id===id);if(!s||!s.email){toast('âš ï¸ Sin email','error');return;}document.getElementById('emTo').value=s.email;document.getElementById('emStudent').value=`${s.name} (${s.course})`;document.getElementById('emSubject').value=`Incidencia - ${s.name} - ${CE}`;document.getElementById('emBody').value=`Estimado/a padre/madre de ${s.name},\n\nDesde ${CE} (${CD}):\n\n\n\nUn cordial saludo.\n${CE}`;document.getElementById('emailModal').classList.add('active');}
function doSendEmail(){const to=document.getElementById('emTo').value;gmail(to,document.getElementById('emSubject').value,document.getElementById('emBody').value);closeModal('emailModal');toast('ğŸ“§ Gmail abierto','info');}
function closeModal(id){document.getElementById(id).classList.remove('active');}
document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',function(e){if(e.target===this)this.classList.remove('active');});});

// CONDUCT DETAIL
let curGrav='leve';
function setGrav(l){curGrav=l;['gL','gM','gG'].forEach(id=>{document.getElementById(id).className='gravity-btn';});document.getElementById({leve:'gL',moderada:'gM',grave:'gG'}[l]).className=`gravity-btn active-${l}`;}
function openCDetail(sid,w,d){const s=S.find(x=>x.id===sid);if(!s)return;document.getElementById('cdId').value=sid;document.getElementById('cdWeek').value=w;document.getElementById('cdDay').value=d;document.getElementById('cdName').textContent=`ğŸ“Œ ${s.name} (${s.course}) â€” ${dn(d)}`;const ex=getCDet(w,d,sid);if(ex){document.getElementById('cdType').value=ex.type||'disruptive';document.getElementById('cdDesc').value=ex.description||'';setGrav(ex.gravity||'leve');document.getElementById('cdNotifyP').checked=ex.notifyP||false;}else{document.getElementById('cdType').value='disruptive';document.getElementById('cdDesc').value='';setGrav('leve');document.getElementById('cdNotifyP').checked=false;}document.getElementById('conductDetailModal').classList.add('active');}
function saveConductDetail(){const sid=document.getElementById('cdId').value,w=document.getElementById('cdWeek').value,d=document.getElementById('cdDay').value,s=S.find(x=>x.id===sid);const det={type:document.getElementById('cdType').value,description:document.getElementById('cdDesc').value.trim(),gravity:curGrav,notifyP:document.getElementById('cdNotifyP').checked,ts:new Date().toISOString()};setCDet(w,d,sid,det);if(det.notifyP&&s&&s.email){gmail(s.email,`Comportamiento - ${s.name} - ${CE}`,`Estimado/a padre/madre de ${s.name},\n\n${CE} (${CD}):\n\nğŸ“… ${dn(d)}\nğŸ“‹ ${TL[det.type]||det.type}\nâš ï¸ ${curGrav}\n${det.description?'ğŸ“ '+det.description+'\n':''}\nSaludos.\n${CE}`);}closeModal('conductDetailModal');toast('ğŸ’¾','success');if(document.getElementById('conductWeek').value)loadCat('conduct');}
function setCDet(w,d,id,det){let bd=JSON.parse(localStorage.getItem('conductDetails')||'{}');if(!bd[w])bd[w]={};if(!bd[w][d])bd[w][d]={};bd[w][d][id]=det;localStorage.setItem('conductDetails',JSON.stringify(bd));}
function getCDet(w,d,id){const bd=JSON.parse(localStorage.getItem('conductDetails')||'{}');return(bd[w]&&bd[w][d]&&bd[w][d][id])||null;}
function getCDets(w,id){const bd=JSON.parse(localStorage.getItem('conductDetails')||'{}');if(!bd[w])return[];const r=[];Object.keys(bd[w]).forEach(d=>{if(bd[w][d][id])r.push({...bd[w][d][id],day:d});});return r;}

// REPORTS
function loadReports(){const w=document.getElementById('reportsWeek').value,cf=document.getElementById('reportsCourseFilter').value;if(!w)return;let f=cf?S.filter(s=>s.course===cf):[...S];let nA=0,nW=0,nC=0,nWr=0;const aL=[],wL=[],cL=[],wrL=[];f.forEach(s=>{const a=wsum(w,'attendance',s.id).filter(d=>d.status==='absent');const b=wsum(w,'behavior',s.id).filter(d=>d.status==='bad'||d.status==='regular');const co=wsum(w,'conduct',s.id).filter(d=>d.status==='malo'||d.status==='regular');const wr=wsum(w,'writings',s.id).filter(d=>d.status==='not-delivered'||d.status==='late');if(a.length){nA++;aL.push({...s,days:a});}if(b.length){nW++;wL.push({...s,days:b});}if(co.length){nC++;cL.push({...s,days:co,details:getCDets(w,s.id)});}if(wr.length){nWr++;wrL.push({...s,days:wr});}});
document.getElementById('reportStatsGrid').innerHTML=`<div class="stat-card blue"><div class="stat-number">${f.length}</div><div class="stat-label">Total</div></div><div class="stat-card red"><div class="stat-number">${nA}</div><div class="stat-label">Ausentes</div></div><div class="stat-card yellow"><div class="stat-number">${nW}</div><div class="stat-label">Mal Trabajo</div></div><div class="stat-card purple"><div class="stat-number">${nC}</div><div class="stat-label">Mal Comport.</div></div><div class="stat-card red"><div class="stat-number">${nWr}</div><div class="stat-label">Sin Writing</div></div>`;
document.getElementById('rAbsent').innerHTML=rRL(aL);document.getElementById('rWork').innerHTML=rRL(wL);document.getElementById('rConduct').innerHTML=rRL(cL,'conduct');document.getElementById('rWriting').innerHTML=rRL(wrL);}
function rRL(list,type){if(!list.length)return'<p style="color:#059669;font-weight:600;">âœ… OK</p>';let h='<ul class="summary-list">';list.forEach(s=>{const tags=s.days.map(d=>`<span class="day-tag absent-day">${dn(d.day)} â€” ${SL[d.status]||d.status}</span>`).join(' ');let detH='';if(type==='conduct'&&s.details&&s.details.length)detH='<div style="margin-top:4px;font-size:.75rem;color:var(--text-sec);">'+s.details.map(d=>`â–¸ ${TL[d.type]||d.type} <span class="behav-type-tag ${d.gravity}">${d.gravity}</span> ${d.description?'â€” '+d.description:''}`).join('<br>')+'</div>';h+=`<li><div><strong>${s.name}</strong> <span class="student-course">${s.course}</span><br><div style="margin-top:4px;">${tags}</div>${detH}</div><div class="inline-flex"><button class="email-btn ${!s.email?'disabled':''}" onclick="openEmail('${s.id}')">ğŸ“§</button><button class="edit-email-btn" onclick="openEdit('${s.id}')">âœï¸</button></div></li>`;});return h+'</ul>';}

// DIRECTOR via GMAIL
function openDirectorEmailModal(){document.getElementById('dirEmail').value=localStorage.getItem('directorEmail')||DE;const dw=document.getElementById('dirWeek');if(!dw.value)dw.value=cw();updFilters();refreshDirPreview();document.getElementById('directorEmailModal').classList.add('active');}
function buildDirText(w,cf){let f=cf?S.filter(s=>s.course===cf):[...S];let t=`INFORME SEMANAL\n${CE}\n${CD}\n${'â•'.repeat(40)}\nSemana: ${w} (${wdr(w)})\n`;if(cf)t+=`Curso: ${cf}\n`;t+=`Total: ${f.length}\n${'â•'.repeat(40)}\n\n`;
const aL=[];f.forEach(s=>{const sum=wsum(w,'attendance',s.id).filter(d=>d.status==='absent');if(sum.length)aL.push({name:s.name,course:s.course,days:sum});});t+=`âŒ FALTAS (${aL.length})\n${'â”€'.repeat(35)}\n`;if(!aL.length)t+='âœ… Sin faltas\n\n';else{aL.forEach(s=>{t+=`â€¢ ${s.name} (${s.course})\n`;s.days.forEach(d=>{t+=`  Â· ${dn(d.day)}${d.note?' â€” '+d.note:''}\n`;});});t+='\n';}
const bL=[];f.forEach(s=>{const sum=wsum(w,'behavior',s.id).filter(d=>d.status==='bad'||d.status==='regular');if(sum.length)bL.push({name:s.name,course:s.course,days:sum});});t+=`â­ TRABAJO (${bL.length})\n${'â”€'.repeat(35)}\n`;if(!bL.length)t+='âœ… OK\n\n';else{bL.forEach(s=>{t+=`â€¢ ${s.name} (${s.course})\n`;s.days.forEach(d=>{t+=`  Â· ${dn(d.day)} â€” ${SL[d.status]||d.status}${d.note?' â€” '+d.note:''}\n`;});});t+='\n';}
const coL=[];f.forEach(s=>{const sum=wsum(w,'conduct',s.id).filter(d=>d.status==='malo'||d.status==='regular');if(sum.length)coL.push({name:s.name,course:s.course,days:sum,details:getCDets(w,s.id)});});t+=`ğŸš¦ COMPORTAMIENTO (${coL.length})\n${'â”€'.repeat(35)}\n`;if(!coL.length)t+='âœ… OK\n\n';else{coL.forEach(s=>{t+=`â€¢ ${s.name} (${s.course})\n`;s.days.forEach(d=>{t+=`  Â· ${dn(d.day)} â€” ${SL[d.status]||d.status}${d.note?' â€” '+d.note:''}\n`;});if(s.details.length)s.details.forEach(d=>{t+=`    â–¸ ${TLS[d.type]||d.type} | ${d.gravity}${d.description?' | '+d.description:''}\n`;});});t+='\n';}
const wrL=[];f.forEach(s=>{const sum=wsum(w,'writings',s.id).filter(d=>d.status==='not-delivered'||d.status==='late');if(sum.length)wrL.push({name:s.name,course:s.course,days:sum});});t+=`ğŸ“ WRITINGS (${wrL.length})\n${'â”€'.repeat(35)}\n`;if(!wrL.length)t+='âœ… OK\n\n';else{wrL.forEach(s=>{t+=`â€¢ ${s.name} (${s.course})\n`;s.days.forEach(d=>{t+=`  Â· ${dn(d.day)} â€” ${SL[d.status]||d.status}${d.note?' â€” '+d.note:''}\n`;});});t+='\n';}
t+=`${'â•'.repeat(40)}\n${new Date().toLocaleString('es-ES')}\n${CF}`;return t;}
function refreshDirPreview(){const w=document.getElementById('dirWeek').value;document.getElementById('dirPreview').textContent=w?buildDirText(w,document.getElementById('dirCourse').value):'Selecciona semana';}
function sendDirOnly(){const em=document.getElementById('dirEmail').value.trim();if(!em){toast('âš ï¸','error');return;}localStorage.setItem('directorEmail',em);const w=document.getElementById('dirWeek').value;let body=buildDirText(w,document.getElementById('dirCourse').value);const ex=document.getElementById('dirExtra').value.trim();if(ex)body+=`\n\nOBS:\n${ex}`;gmail(em,`Informe ${w} â€” ${CE}`,body);closeModal('directorEmailModal');toast('ğŸ“§ Gmail','info');}
function sendDirPDF(){const em=document.getElementById('dirEmail').value.trim();if(!em){toast('âš ï¸','error');return;}localStorage.setItem('directorEmail',em);const w=document.getElementById('dirWeek').value;if(!w){toast('âš ï¸','error');return;}const cf=document.getElementById('dirCourse').value;const fn=genDirPDF(w,cf);let body=buildDirText(w,cf);const ex=document.getElementById('dirExtra').value.trim();if(ex)body+=`\n\nOBS:\n${ex}`;body+=`\n\nğŸ“ ADJUNTO: ${fn}\n(Adjunta el PDF descargado a este correo)`;setTimeout(()=>{gmail(em,`Informe ${w} â€” ${CE} [PDF]`,body);},1000);closeModal('directorEmailModal');toast('ğŸ“„+ğŸ“§ Gmail','success');}

// BULK EMAILS via GMAIL
function sendBulkEmails(){const w=document.getElementById('reportsWeek').value;if(!w){toast('âš ï¸','error');return;}const cf=document.getElementById('reportsCourseFilter').value;let f=cf?S.filter(s=>s.course===cf):[...S];const el=[];f.forEach(s=>{const issues=[];const a=wsum(w,'attendance',s.id).filter(d=>d.status==='absent');const b=wsum(w,'behavior',s.id).filter(d=>d.status==='bad'||d.status==='regular');const co=wsum(w,'conduct',s.id).filter(d=>d.status==='malo'||d.status==='regular');const wr=wsum(w,'writings',s.id).filter(d=>d.status==='not-delivered'||d.status==='late');if(a.length)issues.push(`Faltas: ${a.map(d=>dn(d.day)).join(', ')}`);if(b.length)issues.push(`Trabajo: ${b.map(d=>dn(d.day)+' ('+SL[d.status]+')').join(', ')}`);if(co.length){let cDets=getCDets(w,s.id);let cStr=co.map(d=>dn(d.day)+' ('+SL[d.status]+')').join(', ');if(cDets.length)cStr+='\n    '+cDets.map(d=>`${TLS[d.type]||d.type} (${d.gravity})${d.description?' â€” '+d.description:''}`).join('\n    ');issues.push(`Comportamiento: ${cStr}`);}if(wr.length)issues.push(`Writing: ${wr.map(d=>dn(d.day)+' ('+SL[d.status]+')').join(', ')}`);if(issues.length&&s.email)el.push({email:s.email,name:s.name,issues});});if(!el.length){toast('âœ…','success');return;}if(confirm(`Abrir ${el.length} emails en Gmail`)){el.forEach((e,i)=>{setTimeout(()=>{gmail(e.email,`Incidencias â€” ${e.name} â€” ${CE}`,`Estimado/a padre/madre de ${e.name},\n\n${CE} (${CD}), semana ${wdr(w)}:\n\n${e.issues.map(x=>'â€¢ '+x).join('\n')}\n\nSaludos.\n${CE}`);},i*800);});toast(`ğŸ“§ ${el.length} Gmail...`,'info');}}

// PDF
const PB=[30,58,95],PR=[220,38,38],PW=[248,250,252];
function addH(doc,title,w,cf){doc.setFillColor(...PB);doc.rect(0,0,210,38,'F');doc.setFillColor(...PR);doc.rect(0,38,210,3,'F');doc.setTextColor(255,255,255);doc.setFontSize(14);doc.setFont(undefined,'bold');doc.text(CE,14,16);doc.setFontSize(9);doc.setFont(undefined,'normal');doc.text(CD,14,23);doc.setFontSize(10);doc.setFont(undefined,'bold');doc.text(title,14,32);doc.setFontSize(8);doc.setFont(undefined,'normal');doc.text(`Semana: ${w}`,196,16,{align:'right'});doc.text(wdr(w),196,22,{align:'right'});let y=28;if(cf){doc.text(`Curso: ${cf}`,196,y,{align:'right'});y+=6;}doc.text(new Date().toLocaleDateString('es-ES'),196,y,{align:'right'});doc.setTextColor(0,0,0);return 48;}
function addF(doc){const p=doc.internal.getNumberOfPages();for(let i=1;i<=p;i++){doc.setPage(i);const h=doc.internal.pageSize.height;doc.setFillColor(...PB);doc.rect(0,h-14,210,14,'F');doc.setFillColor(...PR);doc.rect(0,h-14,210,2,'F');doc.setTextColor(255,255,255);doc.setFontSize(7);doc.text(CF,14,h-5);doc.text(`${i}/${p}`,196,h-5,{align:'right'});doc.setTextColor(0,0,0);}}

function genCatPage(doc,cat,w,cf,filtered){const sy=addH(doc,CT[cat],w,cf);const neg=CN[cat];const inc=[];filtered.forEach(s=>{const sum=wsum(w,cat,s.id).filter(d=>neg.includes(d.status));if(sum.length){const det=cat==='conduct'?getCDets(w,s.id):[];inc.push({s,days:sum,det});}});doc.setFontSize(10);doc.setFont(undefined,'bold');doc.setTextColor(...PB);doc.text(`Incidencias: ${inc.length} de ${filtered.length}`,14,sy);doc.setTextColor(0,0,0);if(inc.length){const heads=cat==='conduct'?[['#','Alumno','Curso','DÃ­as','Tipo/Gravedad','Email']]:[['#','Alumno','Curso','DÃ­as','Notas','Email']];doc.autoTable({startY:sy+6,head:heads,body:inc.map((it,i)=>{const ds=it.days.map(d=>`${dn(d.day)} (${SL[d.status]||d.status})`).join(', ');let extra='';if(cat==='conduct'&&it.det.length)extra=it.det.map(d=>`${TLS[d.type]||d.type} (${d.gravity})${d.description?' â€” '+d.description:''}`).join('; ');else extra=it.days.filter(d=>d.note).map(d=>`${fds(d.day)}: ${d.note}`).join('; ');return[i+1,it.s.name,it.s.course,ds,extra||'',it.s.email||''];}),theme:'grid',headStyles:{fillColor:PB,textColor:[255,255,255],fontStyle:'bold',fontSize:7},alternateRowStyles:{fillColor:PW},styles:{fontSize:7,cellPadding:4,lineColor:[200,200,200],lineWidth:.3},columnStyles:{0:{cellWidth:8,halign:'center'},3:{cellWidth:45},4:{cellWidth:45}},didParseCell:function(data){if(data.section==='body'&&data.column.index===3){if(data.cell.raw.includes('Ausente')||data.cell.raw.includes('Mal')||data.cell.raw.includes('No entregado'))data.cell.styles.textColor=PR;else if(data.cell.raw.includes('Regular')||data.cell.raw.includes('Tarde'))data.cell.styles.textColor=[217,119,6];}},margin:{left:14,right:14}});}else{doc.setFontSize(11);doc.setTextColor(5,150,105);doc.text('âœ“ Sin incidencias',14,sy+10);doc.setTextColor(0,0,0);}}

function genPDF(cat){const w=gw(cat);if(!w){toast('âš ï¸','error');return;}const{jsPDF}=window.jspdf;const doc=new jsPDF();const cf=document.getElementById(`${cat}CourseFilter`).value;let f=cf?S.filter(s=>s.course===cf):[...S];f.sort((a,b)=>a.course.localeCompare(b.course)||a.name.localeCompare(b.name));genCatPage(doc,cat,w,cf,f);addF(doc);doc.save(`${CT[cat]}_${w}.pdf`);toast('ğŸ“„','success');}

function genDirPDF(w,cf){const{jsPDF}=window.jspdf;const doc=new jsPDF();let f=cf?S.filter(s=>s.course===cf):[...S];f.sort((a,b)=>a.course.localeCompare(b.course)||a.name.localeCompare(b.name));
doc.setFillColor(...PB);doc.rect(0,0,210,297,'F');doc.setFillColor(...PR);doc.rect(0,100,210,6,'F');doc.rect(0,190,210,6,'F');doc.setTextColor(255,255,255);doc.setFontSize(28);doc.setFont(undefined,'bold');doc.text('INFORME SEMANAL',105,130,{align:'center'});doc.setFontSize(14);doc.text('PARA DIRECCIÃ“N',105,142,{align:'center'});doc.setFontSize(12);doc.setFont(undefined,'normal');doc.text(CE,105,160,{align:'center'});doc.setFontSize(10);doc.text(CD,105,168,{align:'center'});doc.setFontSize(11);doc.text(`Semana: ${w}`,105,210,{align:'center'});doc.text(wdr(w),105,218,{align:'center'});if(cf)doc.text(`Curso: ${cf}`,105,226,{align:'center'});doc.text(`Total: ${f.length}`,105,cf?234:226,{align:'center'});
CATS.forEach(cat=>{doc.addPage();genCatPage(doc,cat,w,cf,f);});addF(doc);const fn=`Informe_Director_${w}.pdf`;doc.save(fn);return fn;}

function genFullReport(){const w=document.getElementById('reportsWeek').value;if(!w){toast('âš ï¸','error');return;}const cf=document.getElementById('reportsCourseFilter').value;const{jsPDF}=window.jspdf;const doc=new jsPDF();let f=cf?S.filter(s=>s.course===cf):[...S];f.sort((a,b)=>a.course.localeCompare(b.course)||a.name.localeCompare(b.name));
doc.setFillColor(...PB);doc.rect(0,0,210,297,'F');doc.setFillColor(...PR);doc.rect(0,100,210,6,'F');doc.rect(0,190,210,6,'F');doc.setTextColor(255,255,255);doc.setFontSize(28);doc.setFont(undefined,'bold');doc.text('INFORME SEMANAL',105,130,{align:'center'});doc.setFontSize(14);doc.text('COMPLETO',105,142,{align:'center'});doc.setFontSize(12);doc.setFont(undefined,'normal');doc.text(CE,105,160,{align:'center'});doc.setFontSize(10);doc.text(CD,105,168,{align:'center'});doc.setFontSize(11);doc.text(`Semana: ${w}`,105,210,{align:'center'});doc.text(wdr(w),105,218,{align:'center'});if(cf)doc.text(`Curso: ${cf}`,105,226,{align:'center'});doc.text(`Total: ${f.length}`,105,cf?234:226,{align:'center'});
CATS.forEach(cat=>{doc.addPage();genCatPage(doc,cat,w,cf,f);});addF(doc);doc.save(`Informe_Completo_${w}.pdf`);toast('ğŸ“„','success');}

// BACKUP
function exportAllData(){const data={students:S,weeklyData:W,conductDetails:JSON.parse(localStorage.getItem('conductDetails')||'{}'),directorEmail:localStorage.getItem('directorEmail')||'',exportDate:new Date().toISOString(),version:'6.0'};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`backup_${new Date().toISOString().slice(0,10)}.json`;a.click();URL.revokeObjectURL(url);toast('ğŸ’¾','success');}
function importAllData(){document.getElementById('importDataInput').click();}
function handleImportData(e){const file=e.target.files[0];if(!file)return;const r=new FileReader();r.onload=function(ev){try{const data=JSON.parse(ev.target.result);if(data.students){if(confirm(`Importar ${data.students.length}?`)){S=data.students;W=data.weeklyData||{};if(data.conductDetails)localStorage.setItem('conductDetails',JSON.stringify(data.conductDetails));if(data.behaviorDetails){const bd=data.behaviorDetails,cd=JSON.parse(localStorage.getItem('conductDetails')||'{}');Object.keys(bd).forEach(w=>{if(!cd[w])cd[w]={};Object.keys(bd[w]).forEach(d=>{if(!cd[w][d])cd[w][d]={};Object.keys(bd[w][d]).forEach(id=>{if(!cd[w][d][id])cd[w][d][id]=bd[w][d][id];});});});localStorage.setItem('conductDetails',JSON.stringify(cd));}if(data.directorEmail)localStorage.setItem('directorEmail',data.directorEmail);ss();sw();updFilters();renderStudents();toast('ğŸ“‚','success');}}else toast('âŒ','error');}catch(err){toast('âŒ','error');}};r.readAsText(file);e.target.value='';}
function confirmClearAll(){if(confirm('âš ï¸ Â¿BORRAR TODO?')&&confirm('ğŸ”´ CONFIRMAR')){S=[];W={};localStorage.removeItem('conductDetails');ss();sw();updFilters();renderStudents();toast('ğŸ—‘ï¸','info');}}

function init(){migrate();updFilters();renderStudents();const c=cw(),t=today();document.querySelectorAll('input[type="week"]').forEach(i=>{if(!i.value)i.value=c;});document.querySelectorAll('input[type="date"]').forEach(i=>{if(!i.value)i.value=t;});}
init();
</script>
</body>
</html>
